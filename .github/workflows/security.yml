name: security

on:
  push:
    branches: ["main"]
  pull_request:
  schedule:
    - cron: "0 3 * * 1"
  workflow_dispatch:

permissions:
  contents: read

jobs:
  gitleaks:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11
      - name: Secret scan (gitleaks)
        run: |
          docker run --rm \
            -v "${{ github.workspace }}:/repo" \
            zricethezav/gitleaks:8.18.2 \
            detect --source=/repo --no-git --redact

  trivy:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11
      - name: Filesystem scan (trivy)
        run: |
          docker run --rm \
            -v "${{ github.workspace }}:/repo" \
            aquasec/trivy:0.55.1 \
            fs --severity HIGH,CRITICAL --exit-code 1 /repo

  bandit:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11
      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
        with:
          python-version: "3.12"
      - name: Install bandit
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install bandit
      - name: Python SAST (bandit)
        run: bandit -r backend/src -ll

  trivy_images:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11
      - name: Build images
        run: |
          docker build -t dealguard-backend -f backend/Dockerfile --target production backend
          docker build -t dealguard-frontend -f frontend/Dockerfile --target production frontend
      - name: Container scan (trivy)
        run: |
          docker run --rm -v /var/run/docker.sock:/var/run/docker.sock aquasec/trivy:0.55.1 \
            image --severity HIGH,CRITICAL --exit-code 1 dealguard-backend
          docker run --rm -v /var/run/docker.sock:/var/run/docker.sock aquasec/trivy:0.55.1 \
            image --severity HIGH,CRITICAL --exit-code 1 dealguard-frontend

  dependency_audit:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11
      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
        with:
          python-version: "3.12"
          cache: pip
          cache-dependency-path: backend/pyproject.toml
      - name: Python dependency audit (pip-audit)
        working-directory: backend
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install -e ".[dev]"
          python3 -m pip install pip-audit==2.7.3
          pip-audit -l
      - name: Set up Node
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: frontend/package-lock.json
      - name: Node dependency audit (npm audit)
        working-directory: frontend
        run: |
          npm ci
          npm audit --omit=dev --audit-level=high

  dast:
    runs-on: ubuntu-24.04
    if: ${{ secrets.STAGING_BASE_URL != '' }}
    steps:
      - name: DAST (OWASP ZAP baseline)
        env:
          ZAP_TARGET: ${{ secrets.STAGING_BASE_URL }}
        run: |
          if [ -z "$ZAP_TARGET" ]; then
            echo "STAGING_BASE_URL is not set; skipping."
            exit 0
          fi
          docker run --rm -t -v "${{ github.workspace }}:/zap/wrk" \
            owasp/zap2docker-stable:2.15.0 \
            zap-baseline.py -t "$ZAP_TARGET" -r zap_report.html
